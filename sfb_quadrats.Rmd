---
title: "SFBay Rocky Shore Survey analyses"
author: "Karina J. Nielsen"
date: "Last compiled on `r format(Sys.time(), '%d %B %Y')`"
output: bookdown::html_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      fig.align = "left",
                      fig.width = 6,
                      fig.height = 4,
                      dev = "png",
                      cache = TRUE)


# echo = FALSE means code will not print, by default
#cache = TRUE saves output results of all chunks so that they do not ned to be rerun

```


```{r library, include=FALSE}
library("easypackages")
my_packages <- c("renv", "easypackages",  "here", "ggthemes", "gridExtra", "tidyverse", "lubridate", "patchwork", "tinytex", "bookdown", "ggpubr") 
libraries(my_packages)

# Install packages if needed
# install.packages("easypackages")
# packages(my_packages) 

# checks to make sure the packages needed are loaded and asks before installing to confirm install in the console window
```

```{r renv, include=FALSE}
#Track/maintain package versions in workflow

#renv::init # to initialize a new project-local environment with a private R library
#run as needed later in the project to capture required package versions

renv::snapshot() 

#NB must respond and affirm actions in console or you will see the spinning wheel....
#reference for renv workflow: https://rstudio.github.io/renv/articles/renv.html

```

```{r functions}

#As needed...

```


```{r here, include=FALSE}

## Confirm working directory for project
here::here() # use this to work with sub-directories less awkwardly and share projects across users/machines more easily.
```



```{r read, message=FALSE}
##Reads in *.csv data files to tibbles and keeps first row as column names

rqs <- read_csv(here::here ("data","sfbay_rockweed_quadrat_surveys.csv"), col_names = TRUE) 

rqs.loc <- read_csv(here::here ("data","sfbay_rockweed_site_names_locations.csv"), col_names = TRUE) 


```

```{r wrangle, include=FALSE}

# Updates rqs$date formatting from chr to POSIXct
rqs <- mutate(rqs, date = as.POSIXct(rqs$date, tz = "America/Los_Angeles", format = "%m/%d/%Y")) 

# Convert zone character variable to factor variable with ordered levels
rqs <- mutate(rqs, zone = as.factor(rqs$zone)) 
rqs$zone <- ordered(rqs$zone, levels = c("Low", "Mid", "High")) 

rqs.loc$bay_perim_order = as.factor(rqs.loc$bay_perim_order)
select(rqs.loc, -notes)

# merges rqs and rqs.loc by site codes

rqs2 <- dplyr::full_join(rqs, rqs.loc, by = "site_code")
rqs2

# creates column with RTC vs. all other sites for 'spotlighting" in graphs, reorders some columns

rqs3 <- rqs2 %>% 
  mutate(RTC_sites = case_when(
        site_code %in% c("PBS", "PCR", "PCW", "PCB", "PCC", "RTCR", "RTCC", "RTCS", "SQB")  ~ "RTC",
        site_code %in% c("SWR", "SFMS", "RRR", "POC", "POB", "PMB", "MKR", "KBB", "HCR", "DPR", "BPB")  ~ "other"),
        .after = site
  )%>%
  relocate(lat, .after = site_code)%>%
  relocate(long, .after = lat)%>%
  relocate(bay_perim_order, .after = site_code)

rqs3 <- mutate(rqs3, RTC_sites = as.factor(rqs3$RTC_sites))
rqs3$RTC_sites <- ordered(rqs3$RTC_sites, levels = c("RTC", "other")) 
rqs3 

# Creates site x zone summary data sets and merges with site type 

## Mid zone

rqs4 <- rqs3 %>%
    filter(zone == "Mid") %>%
    drop_na(fucus_pc, oyster_n) %>%
    group_by(site_code) %>%                                                         # Specify group indicator
    summarise(fucus_pc_avg = mean(fucus_pc), oyster_n_avg = mean(oyster_n))         # Specify column, function, and new name
rqs4

rqs5 <- full_join(rqs4, rqs.loc, by = "site_code")
rqs5 <- rqs5 %>%
  select(site_code, fucus_pc_avg, oyster_n_avg, site_type)
rqs5

##Low zone

rqs6 <- rqs3 %>%
    filter(zone == "Low") %>%
    drop_na(fucus_pc, oyster_n) %>%
    group_by(site_code) %>%                                                         # Specify group indicator
    summarise(fucus_pc_avg = mean(fucus_pc), oyster_n_avg = mean(oyster_n))         # Specify column, function, and new name
rqs6
rqs7 <- full_join(rqs6, rqs.loc, by = "site_code")
rqs7 <- rqs7 %>%
  select(site_code, fucus_pc_avg, oyster_n_avg, site_type)
rqs7


```

# Plots of quadrat data from each transect {#anchor}
## Rockweed, *Fucus distichus*

```{r fucus x zone, include=FALSE}

# Mid + low zone Fucus cover x site, ordered around SFBay perimeter

fucus_p1 <- rqs3 %>% 
  drop_na(fucus_pc) %>% 
  filter(zone != "High") %>% 
  ggplot (aes(x = bay_perim_order, y = fucus_pc, fill = zone)) +
  geom_boxplot(outlier.size =0) +
  geom_point(pch=21, position = position_jitterdodge())+
  theme_few()+
  scale_fill_few(palette = "Light")+
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  scale_x_discrete(breaks= c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20), 
        labels=c("SF Marina","Horseshoe Bay","Dunphy Park", "Brickyard Park", "RTC Beach", "RTC Theater", "RTC North Dock", "Pt. Chauncey", "Pt. Chauncey Beach S", "Pt. Chauncey Beach N", "Paradise Beach Park", "Paradise Cay", "San Quentin Beach", "Starkweather Park", "Pt. San Pablo", "Pt. Orient N", "Pt. Orient S", "Pt. Molate", "Keller Beach", "Miller Knox"))
  
fucus_p1

```

```{r fucus mid, include=FALSE}

#Mid zone Fucus cover x site, ordered around SFBay perimeter, highlighting RTC sites

fucus_p2 <- rqs3 %>% 
  drop_na(fucus_pc) %>% 
  filter(zone == "Mid") %>% 
  ggplot (aes(x = bay_perim_order, y = fucus_pc, fill = RTC_sites)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(pch=21, position = position_jitterdodge(jitter.height = 2, jitter.width = 1, seed = 7))+
  scale_fill_manual(values=c("darkolivegreen4", "light grey")) +
  theme_few()+
  theme(legend.position = "none") +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  scale_x_discrete(breaks= c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20), 
        labels=c("SF Marina","Horseshoe Bay","Dunphy Park", "Brickyard Park", "RTC Beach", "RTC Theater", "RTC North Dock", "Pt. Chauncey", "Pt. Chauncey Beach S", "Pt. Chauncey Beach N", "Paradise Beach Park", "Paradise Cay", "San Quentin Beach", "Starkweather Park", "Pt. San Pablo", "Pt. Orient N", "Pt. Orient S", "Pt. Molate", "Keller Beach", "Miller Knox"))+
  labs(x = NULL,  y = expression(paste(italic(" Fucus distichus"), " cover (%)")))
  
fucus_p2

```

```{r fucus low, include=FALSE}

#Low zone Fucus cover x site, ordered around SFBay perimeter, highlighting RTC sites

fucus_p3 <- rqs3 %>% 
  drop_na(fucus_pc) %>% 
  filter(zone == "Low") %>% 
  ggplot (aes(x = bay_perim_order, y = fucus_pc, fill = RTC_sites)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(pch=21, position = position_jitterdodge(jitter.height = 2, jitter.width = 1, seed = 7))+
  scale_fill_manual(values=c("darkolivegreen4", "light grey")) +
  theme_few()+
  theme(legend.position = "none") +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  scale_x_discrete(breaks= c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20), 
        labels=c("SF Marina","Horseshoe Bay","Dunphy Park", "Brickyard Park", "RTC Beach", "RTC Theater", "RTC North Dock", "Pt. Chauncey", "Pt. Chauncey Beach S", "Pt. Chauncey Beach N", "Paradise Beach Park", "Paradise Cay", "San Quentin Beach", "Starkweather Park", "Pt. San Pablo", "Pt. Orient N", "Pt. Orient S", "Pt. Molate", "Keller Beach", "Miller Knox"))+
  labs(x = NULL,  y = expression(paste(italic(" Fucus distichus"), " cover (%)")))
  
fucus_p3 
```

```{r fucus mid sitetype, include=FALSE}

#Mid zone Fucus cover x sitetype

fucus_p4 <- rqs5 %>% 
  filter(site_type != "blocks") %>%
  filter(site_type != "seawall") %>%
  ggplot (aes(x = site_type, y = fucus_pc_avg, fill= site_type)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(pch=21, position = position_jitterdodge(jitter.height = 0.1, jitter.width = 0.1, seed = 7))+
  theme_few()+
  theme(legend.position = "none") +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  labs(x = "site type",  y = expression(paste(italic(" Fucus distichus"), " cover (%)")))
  
fucus_p4 
```

```{r fucus low sitetype, include=FALSE}

#LowMid zone Fucus cover x sitetype

fucus_p5 <- rqs7 %>% 
  filter(site_type != "blocks") %>%
  filter(site_type != "seawall") %>%
  drop_na(fucus_pc_avg) %>% 
  ggplot (aes(x = site_type, y = fucus_pc_avg, fill= site_type)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(pch=21, position = position_jitterdodge(jitter.height = 0.1, jitter.width = 0.5, seed = 7))+
  theme_few()+
  theme(legend.position = "none") +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  labs(x = "site type",  y = expression(paste(italic(" Fucus distichus"), " cover (%)")))
  
fucus_p5 
```
## Native oyster, *Ostrea lurida*

```{r ostrea x zone,include=FALSE}

#Mid + Low zone native oyster density (no. per m2) x site, ordered around SFBay perimeter

oysters_p1 <- rqs3 %>% 
  drop_na(oyster_n) %>% 
  filter(zone != "High") %>% 
  ggplot (aes(x = bay_perim_order, y = (oyster_n * 4), fill = zone)) + # density per Q * 4 = no/m2
  geom_boxplot(outlier.size =0) +
  geom_point(pch=21, position = position_jitterdodge())+
  theme_few()+
  scale_fill_few(palette = "Light")+
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  scale_x_discrete(breaks= c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20), 
        labels=c("SF Marina","Horseshoe Bay","Dunphy Park", "Brickyard Park", "RTC Beach", "RTC Theater", "RTC North Dock", "Pt. Chauncey", "Pt. Chauncey Beach S", "Pt. Chauncey Beach N", "Paradise Beach Park", "Paradise Cay", "San Quentin Beach", "Starkweather Park", "Pt. San Pablo", "Pt. Orient N", "Pt. Orient S", "Pt. Molate", "Keller Beach", "Miller Knox"))
  
oysters_p1
```

```{r ostrea mid, include=FALSE}

#Mid zone native oyster density (no. per m2) x site, ordered around SFBay perimeter, highlighting RTC sites

oysters_p2 <- rqs3 %>%
  drop_na(oyster_n) %>% 
  filter(zone == "Mid") %>% 
  ggplot (aes(x = bay_perim_order, y = (oyster_n *4), fill = RTC_sites)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(pch=21, position = position_jitterdodge(jitter.height = 2, jitter.width = 1, seed = 7))+
  scale_fill_manual(values=c("coral", "light grey")) +
  theme_few()+
  theme(legend.position = "none") +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  scale_x_discrete(breaks= c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20), 
        labels=c("SF Marina","Horseshoe Bay","Dunphy Park", "Brickyard Park", "RTC Beach", "RTC Theater", "RTC North Dock", "Pt. Chauncey", "Pt. Chauncey Beach S", "Pt. Chauncey Beach N", "Paradise Beach Park", "Paradise Cay", "San Quentin Beach", "Starkweather Park", "Pt. San Pablo", "Pt. Orient N", "Pt. Orient S", "Pt. Molate", "Keller Beach", "Miller Knox"))+
  labs(x = NULL,  y = expression(paste(italic("Ostrea lurida "), "abundance ", " (no. ",  m^-2,")")))

oysters_p2 

```

```{r ostrea low, include=FALSE}

#Low zone native oyster density (no. per m2) x site, ordered around SFBay perimeter, highlighting RTC sites

oysters_p3 <- rqs3 %>%
  drop_na(oyster_n) %>% 
  filter(zone == "Low") %>% 
  ggplot (aes(x = bay_perim_order, y = (oyster_n *4), fill = RTC_sites)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(pch=21, position = position_jitterdodge(jitter.height = 2, jitter.width = 1, seed = 7))+
  scale_fill_manual(values=c("coral", "light grey")) +
  theme_few()+
  theme(legend.position = "none") +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  scale_x_discrete(breaks= c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20), 
        labels=c("SF Marina","Horseshoe Bay","Dunphy Park", "Brickyard Park", "RTC Beach", "RTC Theater", "RTC North Dock", "Pt. Chauncey", "Pt. Chauncey Beach S", "Pt. Chauncey Beach N", "Paradise Beach Park", "Paradise Cay", "San   Quentin Beach", "Starkweather Park", "Pt. San Pablo", "Pt. Orient N", "Pt. Orient S", "Pt. Molate", "Keller Beach", "Miller Knox"))+
  labs(x = NULL,  y = expression(paste(italic("Ostrea lurida "), "abundance ", " (no. ",  m^-2,")")))

oysters_p3
```

```{r ostrea mid sitetype, include=FALSE}

#Mid zone Fucus cover x sitetype

oyster_p4 <- rqs5 %>% 
  filter(site_type != "blocks") %>%
  filter(site_type != "seawall") %>%
  drop_na(oyster_n_avg) %>% 
  ggplot (aes(x = site_type, y = oyster_n_avg, fill= site_type)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(pch=21, position = position_jitterdodge(jitter.height = 0.5, jitter.width = 0.5, seed = 7))+
  theme_few()+
  theme(legend.position = "none") +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  labs(x = NULL,  y = expression(paste(italic("Ostrea lurida "), "abundance ", " (no. ",  m^-2,")")))
  
oyster_p4 
```


```{r ostrea low sitetype, include=FALSE}

#Low zone oyster abun x sitetype

oyster_p5 <- rqs7 %>% 
  filter(site_type != "blocks") %>%
  filter(site_type != "seawall") %>%
  drop_na(oyster_n_avg) %>% 
  ggplot (aes(x = site_type, y = oyster_n_avg, fill= site_type)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(pch=21, position = position_jitterdodge(jitter.height = 0.5, jitter.width = 0.5, seed = 7))+
  theme_few()+
  theme(legend.position = "none") +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust = 1))+
  labs(x = NULL,  y = expression(paste(italic("Ostrea lurida "), "abundance ", " (no. ",  m^-2,")")))
  
oyster_p5 
```


```{r Fig.1, fig.width = 6, fig.height = 8, fig.cap = " Abundance of rockweed (Fucus distichus) and native oysters (Ostrea lurida) in the mid intertidal rockweed zone at survey sites. Colored fill indicates reference sites used for nature-based restoration and climate adaptation planning at the SF State Romberg Tiburon Campus."}

ggarrange(fucus_p2 + rremove("x.text"), oysters_p2, ncol=1, nrow=2,heights= c(0.75, 1), align = "v")

```

```{r Fig.2, fig.width = 6, fig.height = 8, fig.cap = " Abundance of rockweed (Fucus distichus) and native oysters (Ostrea lurida) in the low intertidal (MLLW for most) at survey sites. Colored fill indicates reference sites used for nature-based restoration and climate adaptation planning at the SF State Romberg Tiburon Campus."}

ggarrange(fucus_p3 + rremove("x.text"), oysters_p3, ncol=1, nrow=2,heights= c(0.75, 1), align = "v")

```
```{r Fig.3, fig.width = 4, fig.height = 6, fig.cap = " Abundance of rockweed (Fucus distichus) and native oysters (Ostrea lurida) in the mid intertidal rockweed zone by site type."}

ggarrange(fucus_p4 + rremove("x.text"), oyster_p4, ncol=1, nrow=2,heights= c(0.5, 0.55), align = "v")

```

```{r Fig.4, fig.width = 4, fig.height = 6, fig.cap = " Abundance of rockweed (Fucus distichus) and native oysters (Ostrea lurida) in the low intertidal (MLLW) by site type."}

ggarrange(fucus_p5 + rremove("x.text"), oyster_p5, ncol=1, nrow=2,heights= c(0.5, 0.55), align = "v")

```

```{r, include=FALSE}
## save figure to output folder
# ggsave(here::here("output","oyster_quad_counts.pdf"), width = 20, height = 20, units = "cm")
```

```{r, include=FALSE}
##what's up with Keller Beach mid zone oyster count?
#used this to figure out outlier issue and correct original data file (was a date entry error). #Updated the file in github with a commit note to explain the change.
#saving code chunk here for reference only

# t1 <- rqs3 %>% 
#   group_by(zone, site_name)%>%
#   summarise(min_cov= min(oyster_n, na.rm = TRUE), Q1=quantile(oyster_n, probs = 0.25, na.rm = TRUE), median_cov = median(oyster_n, na.rm = TRUE), Q3=quantile(oyster_n, probs = 0.75, na.rm = TRUE), max_cov = max(oyster_n, na.rm = TRUE)) %>% 
#   arrange(min_cov, Q1, median_cov, Q3, max_cov)
# t1
```


